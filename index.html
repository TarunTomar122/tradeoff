<!DOCTYPE html>
<html lang="en">
	<head>
		<title>The tradeoff</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="./style.css">
        <link rel="stylesheet" href="./skeleton.css">
        <link rel="stylesheet" href="./dark.css">
	</head>
	<body>

		<div class="container">
            <div id="contentarea">
                
                <h3>The tradeoff</h3>
                <p>Let's test your short term memory...</p>
                <input type="button" value="Start Game" onclick="startGame()">

            </div>

            <div id="instructions">

            </div>

            <div id="time-slider">
                <div id="fill"></div>
            </div>

            <div id="scorearea">
            </div>

            <div id="confetti">
                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    viewBox="0 0 800 800" style="enable-background:new 0 0 800 800;" xml:space="preserve">
                    <g class="confetti-cone">
                        <path class="conf0" d="M131.5,172.6L196,343c2.3,6.1,11,6.1,13.4,0l65.5-170.7L131.5,172.6z"/>
                        <path class="conf1" d="M131.5,172.6L196,343c2.3,6.1,11,6.1,13.4,0l6.7-17.5l-53.6-152.9L131.5,172.6z"/>

                        <path class="conf2" d="M274.2,184.2c-1.8,1.8-4.2,2.9-7,2.9l-129.5,0.4c-5.4,0-9.8-4.4-9.8-9.8c0-5.4,4.4-9.8,9.9-9.9l129.5-0.4
                            c5.4,0,9.8,4.4,9.8,9.8C277,180,275.9,182.5,274.2,184.2z"/>
                        <polygon class="conf3" points="231.5,285.4 174.2,285.5 143.8,205.1 262.7,204.7      "/>
                        <path class="conf4" d="M166.3,187.4l-28.6,0.1c-5.4,0-9.8-4.4-9.8-9.8c0-5.4,4.4-9.8,9.9-9.9l24.1-0.1c0,0-2.6,5-1.3,10.6
                            C161.8,183.7,166.3,187.4,166.3,187.4z"/>
                        <ellipse transform="matrix(0.7071 -0.7071 0.7071 0.7071 -89.8523 231.0278)" class="conf2" cx="233.9" cy="224" rx="5.6" ry="5.6"/>
                        <path class="conf5" d="M143.8,205.1l5.4,14.3c6.8-2.1,14.4-0.5,19.7,4.8c7.7,7.7,7.6,20.1-0.1,27.8c-1.7,1.7-3.7,3-5.8,4l11.1,29.4
                            l27.7,0l-28-80.5L143.8,205.1z"/>
                        <path class="conf2" d="M169,224.2c-5.3-5.3-13-6.9-19.7-4.8l13.9,36.7c2.1-1,4.1-2.3,5.8-4C176.6,244.4,176.6,231.9,169,224.2z"/>
                        <ellipse transform="matrix(0.7071 -0.7071 0.7071 0.7071 -119.0946 221.1253)" class="conf6" cx="207.4" cy="254.3" rx="11.3" ry="11.2"/>
                    </g>

                        <rect x="113.7" y="135.7" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -99.5348 209.1582)" class="conf7" width="178" height="178"/>
                    <line class="conf7" x1="76.8" y1="224.7" x2="328.6" y2="224.7"/>
                    <polyline class="conf7" points="202.7,350.6 202.7,167.5 202.7,98.9  "/>
                <!-- here comes the confettis-->

                        <circle class="conf2" id="b1" cx="195.2" cy="232.6" r="5.1"/>
                        <circle class="conf0" id="b2" cx="230.8" cy="219.8" r="5.4"/>
                        <circle class="conf0" id="c2" cx="178.9" cy="160.4" r="4.2"/>
                        <circle class="conf6" id="d2"cx="132.8" cy="123.6" r="5.4"/>
                        <circle class="conf0" id="d3" cx="151.9" cy="105.1" r="5.4"/>

                        <path class="conf0" id="d1" d="M129.9,176.1l-5.7,1.3c-1.6,0.4-2.2,2.3-1.1,3.5l3.8,4.2c1.1,1.2,3.1,0.8,3.6-0.7l1.9-5.5
                        C132.9,177.3,131.5,175.7,129.9,176.1z"/>
                        <path class="conf6" id="b5" d="M284.5,170.7l-5.4,1.2c-1.5,0.3-2.1,2.2-1,3.3l3.6,3.9c1,1.1,2.9,0.8,3.4-0.7l1.8-5.2
                        C287.4,171.9,286.1,170.4,284.5,170.7z"/>
                        <circle class="conf6" id="c3"cx="206.7" cy="144.4" r="4.5"/>
                        <path class="conf2" id="c1" d="M176.4,192.3h-3.2c-1.6,0-2.9-1.3-2.9-2.9v-3.2c0-1.6,1.3-2.9,2.9-2.9h3.2c1.6,0,2.9,1.3,2.9,2.9v3.2
                        C179.3,191,178,192.3,176.4,192.3z"/>
                        <path class="conf2" id="b4" d="M263.7,197.4h-3.2c-1.6,0-2.9-1.3-2.9-2.9v-3.2c0-1.6,1.3-2.9,2.9-2.9h3.2c1.6,0,2.9,1.3,2.9,2.9v3.2
                        C266.5,196.1,265.2,197.4,263.7,197.4z"/>
                        <!-- yellow-strip-1-->
                        <path id="yellow-strip" d="M179.7,102.4c0,0,6.6,15.3-2.3,25c-8.9,9.7-24.5,9.7-29.7,15.6c-5.2,5.9-0.7,18.6,3.7,28.2
                        c4.5,9.7,2.2,23-10.4,28.2"/>
                        <path class="conf8" id="yellow-strip" d="M252.2,156.1c0,0-16.9-3.5-28.8,2.4c-11.9,5.9-14.9,17.8-16.4,29c-1.5,11.1-4.3,28.8-31.5,33.4"/>
                        <path class="conf0" id="a1" d="M277.5,254.8h-3.2c-1.6,0-2.9-1.3-2.9-2.9v-3.2c0-1.6,1.3-2.9,2.9-2.9h3.2c1.6,0,2.9,1.3,2.9,2.9v3.2
                        C280.4,253.5,279.1,254.8,277.5,254.8z"/>
                        <path class="conf3" id="c4" d="M215.2,121.3L215.2,121.3c0.3,0.6,0.8,1,1.5,1.1l0,0c1.6,0.2,2.2,2.2,1.1,3.3l0,0c-0.5,0.4-0.7,1.1-0.6,1.7v0
                        c0.3,1.6-1.4,2.8-2.8,2l0,0c-0.6-0.3-1.2-0.3-1.8,0h0c-1.4,0.7-3.1-0.5-2.8-2v0c0.1-0.6-0.1-1.3-0.6-1.7l0,0
                        c-1.1-1.1-0.5-3.1,1.1-3.3l0,0c0.6-0.1,1.2-0.5,1.5-1.1v0C212.5,119.8,214.5,119.8,215.2,121.3z"/>
                        <path class="conf3" id="b3" d="M224.5,191.7L224.5,191.7c0.3,0.6,0.8,1,1.5,1.1l0,0c1.6,0.2,2.2,2.2,1.1,3.3v0c-0.5,0.4-0.7,1.1-0.6,1.7l0,0
                        c0.3,1.6-1.4,2.8-2.8,2h0c-0.6-0.3-1.2-0.3-1.8,0l0,0c-1.4,0.7-3.1-0.5-2.8-2l0,0c0.1-0.6-0.1-1.3-0.6-1.7v0
                        c-1.1-1.1-0.5-3.1,1.1-3.3l0,0c0.6-0.1,1.2-0.5,1.5-1.1l0,0C221.7,190.2,223.8,190.2,224.5,191.7z"/>
                        <path class="conf3" id="a2" d="M312.6,242.1L312.6,242.1c0.3,0.6,0.8,1,1.5,1.1l0,0c1.6,0.2,2.2,2.2,1.1,3.3l0,0c-0.5,0.4-0.7,1.1-0.6,1.7v0
                        c0.3,1.6-1.4,2.8-2.8,2l0,0c-0.6-0.3-1.2-0.3-1.8,0h0c-1.4,0.7-3.1-0.5-2.8-2v0c0.1-0.6-0.1-1.3-0.6-1.7l0,0
                        c-1.1-1.1-0.5-3.1,1.1-3.3l0,0c0.6-0.1,1.2-0.5,1.5-1.1v0C309.9,240.6,311.9,240.6,312.6,242.1z"/>
                        <path class="conf8" id="yellow-strip" d="M290.7,215.4c0,0-14.4-3.4-22.6,2.7c-8.2,6.2-8.2,23.3-17.1,29.4c-8.9,6.2-19.8-2.7-32.2-4.1
                        c-12.3-1.4-19.2,5.5-20.5,10.9"/>
                    </g>
                </svg>
            </div>

            <div id="leaderboard">
                <h4>Leaderboard</h4>
                <ul id="leaderboardList">
          
                </ul>
            </div>

		</div>

		<script type="x-shader/x-vertex" id="vertexshader">

			varying vec2 vUv;

			void main() {

				vUv = uv;

				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

			}

		</script>

		<script type="x-shader/x-fragment" id="fragmentshader">

			uniform sampler2D baseTexture;
			uniform sampler2D bloomTexture;

			varying vec2 vUv;

			void main() {

				gl_FragColor = ( texture2D( baseTexture, vUv ) + vec4( 1.0 ) * texture2D( bloomTexture, vUv ) );

			}

		</script>

		<script type="importmap">
			{
				"imports": {
					"three": "./three.module.js",
					"three/addons/": "./jsm/"
				}
			}
		</script>

		<script type="module">

			import * as THREE from 'three';

			import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

			import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
			import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
			import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
			import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
			import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
			import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

			const BLOOM_SCENE = 1;

			const bloomLayer = new THREE.Layers();
			bloomLayer.set( BLOOM_SCENE );

			const params = {
				threshold: 0,
				strength: 0.9,
				radius: 0,
				exposure: 0.3
			};

			const darkMaterial = new THREE.MeshBasicMaterial( { color: 'black' } );
			const materials = {};

			const renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.toneMapping = THREE.ReinhardToneMapping;
			document.body.appendChild( renderer.domElement );

			const scene = new THREE.Scene();

			const camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 200 );
			camera.position.set( 0, 0, 20 );
			camera.lookAt( 0, 0, 0 );

			const controls = new OrbitControls( camera, renderer.domElement );
			controls.maxPolarAngle = Math.PI * 0.5;
			controls.minDistance = 1;
			controls.maxDistance = 100;
			controls.addEventListener( 'change', render );

			const renderScene = new RenderPass( scene, camera );

			const bloomPass = new UnrealBloomPass( new THREE.Vector2( window.innerWidth, window.innerHeight ), 1.5, 0.4, 0.85 );
			bloomPass.threshold = params.threshold;
			bloomPass.strength = params.strength;
			bloomPass.radius = params.radius;

			const bloomComposer = new EffectComposer( renderer );
			bloomComposer.renderToScreen = false;
			bloomComposer.addPass( renderScene );
			bloomComposer.addPass( bloomPass );

			const mixPass = new ShaderPass(
				new THREE.ShaderMaterial( {
					uniforms: {
						baseTexture: { value: null },
						bloomTexture: { value: bloomComposer.renderTarget2.texture }
					},
					vertexShader: document.getElementById( 'vertexshader' ).textContent,
					fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
					defines: {}
				} ), 'baseTexture'
			);
			mixPass.needsSwap = true;

			const outputPass = new OutputPass();

			const finalComposer = new EffectComposer( renderer );
			finalComposer.addPass( renderScene );
			finalComposer.addPass( mixPass );
			finalComposer.addPass( outputPass );

			const raycaster = new THREE.Raycaster();

			const mouse = new THREE.Vector2();

			// window.addEventListener( 'pointerdown', onPointerDown );

			function onPointerDown( event ) {

				mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

				raycaster.setFromCamera( mouse, camera );
				const intersects = raycaster.intersectObjects( scene.children, false );
				if ( intersects.length > 0 ) {

					const object = intersects[ 0 ].object;
					object.layers.toggle( BLOOM_SCENE );
					render();

				}

			}

            window.togglePointerDown = onPointerDown;

			window.onresize = function () {

				const width = window.innerWidth;
				const height = window.innerHeight;

				camera.aspect = width / height;
				camera.updateProjectionMatrix();

				renderer.setSize( width, height );

				bloomComposer.setSize( width, height );
				finalComposer.setSize( width, height );

				render();

			};

            let shiningBallsIndex = [];

			function setupScene(totalBalls) {

				scene.traverse( disposeMaterial );
				scene.children.length = 0;

				const geometry = new THREE.IcosahedronGeometry( 1, 15 );

                shiningBallsIndex = [];

				for ( let i = 0; i < totalBalls; i ++ ) {

					const color = new THREE.Color();
					color.setHSL( Math.random(), 0.7, Math.random() * 0.2 + 0.05 );

					const material = new THREE.MeshBasicMaterial( { color: color } );
					const sphere = new THREE.Mesh( geometry, material );
					sphere.position.x = Math.random() * 10 - 5;
					sphere.position.y = Math.random() * 10 - 5;
					sphere.position.z = Math.random() * 10 - 5;
					sphere.position.normalize().multiplyScalar( Math.random() * 4.0 + 2.0 );
					sphere.scale.setScalar( Math.random() * Math.random() + 0.5 );
					scene.add( sphere );

				}

				render();

			}

            // function to toggle the shine on the totalBalls number of balls
            function toggleShine(totalBalls, flag) {
               

                if(flag === false) {
                    for(let i = 0; i < shiningBallsIndex.length; i++) {
                        scene.children[shiningBallsIndex[i]].layers.disable( BLOOM_SCENE );
                    }
                }
                else{
                    
                    if(shiningBallsIndex.length > 0){
                        for(let i = 0; i < scene.children.length; i++) {
                            scene.children[i].layers.disable( BLOOM_SCENE );
                        }
                        for(let i = 0; i < shiningBallsIndex.length; i++) {
                            scene.children[shiningBallsIndex[i]].layers.enable( BLOOM_SCENE );
                        }
                    }
                    else{

                        // pick totalBalls number of different balls randomly
                        for(let i = 0; i < totalBalls; i++) {
                            let index = Math.floor(Math.random() * scene.children.length);
                            if(shiningBallsIndex.includes(index)) {
                                i--;
                                continue;
                            }
                            scene.children[index].layers.enable( BLOOM_SCENE );
                            shiningBallsIndex.push(index);
                        }
                    }
            
                }

                render();

            }


            function checkLevel(){
                // get an array of all the balls that are shining
                let shiningBalls = [];
                scene.children.forEach((ball, index) => {
                    if(ball.layers.isEnabled(1)){
                        shiningBalls.push(index);
                    }
                });

                // sort both arrays
                shiningBalls.sort();
                shiningBallsIndex.sort();

                // check if this array === shiningBallsIndex array 
                if(shiningBalls.length === shiningBallsIndex.length){
                    for(let i = 0; i < shiningBalls.length; i++){
                        if(shiningBalls[i] !== shiningBallsIndex[i]){
                            return false;
                        }
                    }
                    return true;
                }
                else{
                    return false;
                }

            }

            function hideGame(){
                
            }

            window.setupScene = setupScene;
            window.toggleShine = toggleShine;
            window.checkLevel = checkLevel;
            window.hideGame = hideGame;

			function disposeMaterial( obj ) {

				if ( obj.material ) {

					obj.material.dispose();

				}

			}

			function render() {

				scene.traverse( darkenNonBloomed );
				bloomComposer.render();
				scene.traverse( restoreMaterial );

				// render the entire scene, then render bloom scene on top
				finalComposer.render();

			}

			function darkenNonBloomed( obj ) {

				if ( obj.isMesh && bloomLayer.test( obj.layers ) === false ) {

					materials[ obj.uuid ] = obj.material;
					obj.material = darkMaterial;

				}

			}

			function restoreMaterial( obj ) {

				if ( materials[ obj.uuid ] ) {

					obj.material = materials[ obj.uuid ];
					delete materials[ obj.uuid ];

				}

			}

		</script>


        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
            import { getFirestore, collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
        
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
            apiKey: "AIzaSyBGu_l0WbP9atSDjiMwpF6caYysYKQz7vU",
            authDomain: "blob-6b04d.firebaseapp.com",
            projectId: "blob-6b04d",
            storageBucket: "blob-6b04d.appspot.com",
            messagingSenderId: "150568437512",
            appId: "1:150568437512:web:89eef91faae63147364ebd",
            measurementId: "G-4LD3RG84GY"
            };
        
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);

            const updateLeaderBoard = async () => {
            const leaderboardRef = collection(db, "leaderboard");
            const querySnapshot = await getDocs(leaderboardRef);
            querySnapshot.forEach((doc) => {

                // if doc.id !== "tradeoff" then it is not the tradeoff
                if (doc.id !== "tradeoff") {
                return;
                }

                const data = doc.data();

                // data is an object with key as name and value as the highscore
                // sort the object by value and display it in the leaderboard
                const leaderboardList = document.getElementById("leaderboardList");
                var sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
                leaderboardList.innerHTML = "";

                // pick the top 5 scores
                // sortedData = sortedData.slice(0, 5);

                let i = 0;
                sortedData.forEach((entry) => {
                const li = document.createElement("li");
                li.textContent = `${entry[0]} - ${entry[1]}`;

                // add crown to the highest score
                if (i==0) {
                    li.innerHTML = `👑 ${entry[0]} - ${entry[1]}`;
                }

                else if(i==1){
                    li.innerHTML = `🥈 ${entry[0]} - ${entry[1]}`;
                }

                else if(i==2){
                    li.innerHTML = `🥉 ${entry[0]} - ${entry[1]}`;
                }
                else{
                    li.innerHTML = `${i+1}. ${entry[0]} - ${entry[1]}`;
                }
                if(entry[0] == localStorage.getItem("username")){
                        li.style.color = "#fcaf3e";
                }
                    leaderboardList.appendChild(li);
                    i++;
                });

                // console.log("leaderboard updated", sortedData);

            });
            }

            // get the leaderboard from the firestore database
            const db = getFirestore(app);
        
            updateLeaderBoard();

            const saveScore = async (name, score) => {
            // save the score to the firestore database
            const leaderboardRef = collection(db, "leaderboard");
            const querySnapshot = await getDocs(leaderboardRef);
            querySnapshot.forEach((docc) => {

                if(docc.id !== "tradeoff") {
                return;
                }

                let data = docc.data();
                if (data[name]) {
                    if (data[name] < score) {
                        // update the score if the new score is higher
                        const leaderboardRef = collection(db, "leaderboard");
                        setDoc(doc(leaderboardRef, "tradeoff"), {
                        [name]: score
                        }, { merge: true });
                        data[name] = score;
                    }
                } else {
                    // add the new score to the leaderboard
                    const leaderboardRef = collection(db, "leaderboard");
                    setDoc(doc(leaderboardRef, "tradeoff"), {
                        [name]: score
                    }, { merge: true });
                    data = {...data, [name]: score};
                    }

                    // data is an object with key as name and value as the highscore
                    // sort the object by value and display it in the leaderboard
                    const leaderboardList = document.getElementById("leaderboardList");
                    var sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
                    leaderboardList.innerHTML = "";

                    // pick the top 5 scores
                    // sortedData = sortedData.slice(0, 5);

                    let i = 0;
                    let rank = 0;
                    sortedData.forEach((entry) => {
                    const li = document.createElement("li");
                    li.textContent = `${entry[0]} - ${entry[1]}`;

                    // add crown to the highest score
                    if (i==0) {
                        li.innerHTML = `👑 ${entry[0]} - ${entry[1]}`;
                    }

                    else if(i==1){
                        li.innerHTML = `🥈 ${entry[0]} - ${entry[1]}`;
                    }

                    else if(i==2){
                        li.innerHTML = `🥉 ${entry[0]} - ${entry[1]}`;
                    }
                    else{
                        li.innerHTML = `${i+1}. ${entry[0]} - ${entry[1]}`;
                       
                    }
                    if(entry[0] == localStorage.getItem("username")){
                        li.style.color = "#fcaf3e";
                        rank = i+1;
                    }
                    leaderboardList.appendChild(li);
                    i++;
                });

                window.rank = rank;

            });

            }

            window.saveScore = saveScore;
            window.updateLeaderBoard = updateLeaderBoard;

        </script>



        <script type="text/javascript" src="./script.js"></script>

	</body>

</html>